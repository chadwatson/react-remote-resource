"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),React__default=_interopDefault(React),redux=require("redux"),immutable=require("immutable"),Maybe=_interopDefault(require("data.maybe")),PropTypes=_interopDefault(require("prop-types"));function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){var r=[],n=!0,a=!1,o=void 0;try{for(var u,c=e[Symbol.iterator]();!(n=(u=c.next()).done)&&(r.push(u.value),!t||r.length!==t);n=!0);}catch(e){a=!0,o=e}finally{try{n||null==c.return||c.return()}finally{if(a)throw o}}return r}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var Context=React.createContext({registerError:function(){}}),REGISTER_RESOURCE="REGISTER_RESOURCE",RECEIVE_DATA="RECEIVE_DATA",store=redux.createStore(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:immutable.Map(),t=1<arguments.length?arguments[1]:void 0;switch(t.type){case REGISTER_RESOURCE:return e.set(t.resourceId,immutable.Map());case RECEIVE_DATA:return e.setIn([t.resourceId,t.entryKey],immutable.Map({updatedAt:t.now,data:t.data}));default:return e}}),defaultCreateCacheKey=function(e){return e.join("-")||"INDEX"},createRemoteResource=function(e){var p=e.id,t=e.load,a=void 0===t?function(){return Promise.resolve()}:t,r=e.save,R=void 0===r?function(){return Promise.resolve()}:r,n=e.initialValue,y=void 0===n?null:n,o=e.invalidateAfter,E=void 0===o?3e5:o,u=e.createEntryKey,v=void 0===u?defaultCreateCacheKey:u;store.dispatch({type:REGISTER_RESOURCE,resourceId:p});var h=new Map,m=new Map,_=function(e){return Maybe.fromNullable(store.getState().getIn([p,e]))},b=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=v(t);return a.apply(void 0,t).then(function(e){h.delete(n),store.dispatch({type:RECEIVE_DATA,now:Date.now(),data:e,entryKey:n,resourceId:p})}).catch(function(e){throw h.delete(n),e})};return function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n,a=v(t),o=React.useContext(Context).registerError,u=_slicedToArray(React.useState(_(a)),2),c=u[0],i=u[1],s=(n=c,n.map(function(e){return e.get("updatedAt")})).map(function(e){return e+E<Date.now()}).getOrElse(!0);React.useEffect(function(){return store.subscribe(function(){var e=_(a);e!==c&&i(e)})},[a]);var l=React.useRef(0);if(l.current=l.current+1,1===l.current&&s&&!h.has(a)&&h.set(a,b.apply(void 0,t).catch(o)),s&&h.has(a))throw h.get(a);var f,d=React.useMemo(function(){return{refresh:function(){return h.get(a)||h.set(a,b.apply(void 0,t).catch(o)).get(a)},set:function(e){store.dispatch({type:RECEIVE_DATA,now:Date.now(),data:e,entryKey:a,resourceId:p})},update:function(e){store.dispatch({type:RECEIVE_DATA,now:Date.now(),data:e(c),entryKey:a,resourceId:p})},save:function(e){return m.get(a)||m.set(a,R(e).then(function(e){return m.delete(a),e}).catch(function(e){throw m.delete(a),e})).get(a)}}},[a]);return[(f=c,f.map(function(e){return e.get("data")}).getOrElse(y)),d]}},RemoteResourceBoundary=function(e){var t=e.children,r=e.onLoadError,n=e.fallback,a=void 0===n?null:n,o=e.renderError,u=void 0===o?function(e){return null}:o,c=_slicedToArray(React.useState(Maybe.Nothing()),2),i=c[0],s=c[1],l=React.useMemo(function(){return{registerError:function(e){s(Maybe.of(e)),r(e)}}},[r]),f=React.useCallback(function(){s(Maybe.Nothing())},[]);return React__default.createElement(Context.Provider,{value:l},i.map(function(e){return u(e,f)}).getOrElse(React__default.createElement(React.Suspense,{fallback:a},t)))};RemoteResourceBoundary.propTypes={children:PropTypes.node.isRequired,renderError:PropTypes.func.isRequired,onLoadError:PropTypes.func,fallback:PropTypes.node};var useSuspense=function(e){var t=_slicedToArray(React.useState(null),2),r=t[0],n=t[1],a=React.useRef(!0);if(React.useEffect(function(){return function(){a.current=!1}},[]),r)throw r;return function(){return n(e().then(function(){a.current&&n(null)}).catch(function(){a.current&&n(null)}))}};exports.createRemoteResource=createRemoteResource,exports.RemoteResourceBoundary=RemoteResourceBoundary,exports.useSuspense=useSuspense;
