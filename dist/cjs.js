"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),React__default=_interopDefault(React),redux=require("redux"),immutable=require("immutable"),Maybe=_interopDefault(require("data.maybe")),PropTypes=_interopDefault(require("prop-types"));function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,r){var t=[],n=!0,u=!1,a=void 0;try{for(var o,c=e[Symbol.iterator]();!(n=(o=c.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){u=!0,a=e}finally{try{n||null==c.return||c.return()}finally{if(u)throw a}}return t}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var Context=React.createContext({registerError:function(){}}),createTaskManager=function(){var t=new Map;return{has:function(e){return t.has(e)},get:function(e){return t.get(e)},run:function(r,e){return t.get(r)||t.set(r,e().then(function(e){return t.delete(r),e}).catch(function(e){throw t.delete(r),e})).get(r)}}},REGISTER_RESOURCE="REGISTER_RESOURCE",RECEIVE_DATA="RECEIVE_DATA",DELETE_ENTRY="DELETE_ENTRY",SUBSCRIPTION_STARTED="SUBSCRIPTION_STARTED",SUBSCRIPTION_ENDED="SUBSCRIPTION_ENDED",store=redux.createStore(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:immutable.Map(),r=1<arguments.length?arguments[1]:void 0;switch(r.type){case REGISTER_RESOURCE:return e.set(r.resourceId,immutable.Map());case RECEIVE_DATA:return e.setIn([r.resourceId,r.entryKey],immutable.Map({updatedAt:r.now,data:r.data,hasSubscription:!1}));case SUBSCRIPTION_STARTED:return e.setIn([r.resourceId,r.entryKey,"hasSubscription"],!0);case SUBSCRIPTION_ENDED:return e.setIn([r.resourceId,r.entryKey,"hasSubscription"],!1);case DELETE_ENTRY:return e.deleteIn([r.resourceId,r.entryKey]);default:return e}}),defaultCreateCacheKey=function(e){return e.join("-")||"INDEX"},createRemoteResource=function(e){var y=e.id,r=e.load,u=void 0===r?function(){return Promise.resolve()}:r,t=e.save,E=void 0===t?function(){return Promise.resolve()}:t,n=e.delete,h=void 0===n?function(){return Promise.resolve()}:n,a=e.subscribe,m=void 0===a?function(){return function(){}}:a,o=e.initialValue,c=void 0===o?null:o,i=e.invalidateAfter,v=void 0===i?3e5:i,s=e.createEntryKey,T=void 0===s?defaultCreateCacheKey:s;store.dispatch({type:REGISTER_RESOURCE,resourceId:y});var b=createTaskManager(),S=createTaskManager(),I=createTaskManager(),_=function(e){return Maybe.fromNullable(store.getState().getIn([y,e]))},C=function(e){return e.map(function(e){return e.get("data")}).getOrElse(c)},D=function(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var n=T(r);return b.run(n,function(){return u.apply(void 0,r).then(function(e){return store.dispatch({type:RECEIVE_DATA,now:Date.now(),entryKey:T(r),data:e,resourceId:y}),e})})};return function(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var n,u=T(r),a=React.useContext(Context).registerError,o=_slicedToArray(React.useState(_(u)),2),c=o[0],i=o[1],s=C(c),l=c.map(function(e){return e.get("hasSubscription")}).getOrElse(!1),f=(n=c,n.map(function(e){return e.get("updatedAt")})).map(function(e){return e+v<Date.now()}).getOrElse(!0);React.useEffect(function(){return store.subscribe(function(){var e=_(u);e!==c&&i(e)})},[u]);var d=React.useRef(0);if(d.current=d.current+1,1===d.current&&f&&!b.has(u)&&D.apply(void 0,r).catch(a),f&&b.has(u))throw b.get(u);var p=React.useCallback(function(e){var r="function"==typeof e?e(s):e;return store.dispatch({type:RECEIVE_DATA,now:Date.now(),data:r,entryKey:u,resourceId:y}),r},[s]),R={refresh:React.useCallback(function(){return D.apply(void 0,r).catch(a)},[]),setCache:p,deleteCache:React.useCallback(function(){return store.dispatch({type:DELETE_ENTRY,entryKey:u,resourceId:y}),s},[s]),remoteSave:React.useCallback(function(e){S.run(u,function(){return E(e)})},[]),remoteDelete:React.useCallback(function(){I.run(u,function(){return h(s)})},[s]),subscribe:React.useCallback(function(){if(!l){store.dispatch({type:SUBSCRIPTION_STARTED,entryKey:u,resourceId:y});var e=m(p).apply(void 0,r);return function(){e(),store.dispatch({type:SUBSCRIPTION_ENDED,entryKey:u,resourceId:y})}}},[l])};return[C(c),R]}},RemoteResourceBoundary=function(e){var r=e.children,t=e.onLoadError,n=e.fallback,u=void 0===n?null:n,a=e.renderError,o=void 0===a?function(e){return null}:a,c=_slicedToArray(React.useState(Maybe.Nothing()),2),i=c[0],s=c[1],l=React.useMemo(function(){return{registerError:function(e){s(Maybe.of(e)),t(e)}}},[t]),f=React.useCallback(function(){s(Maybe.Nothing())},[]);return React__default.createElement(Context.Provider,{value:l},i.map(function(e){return o(e,f)}).getOrElse(React__default.createElement(React.Suspense,{fallback:u},r)))};RemoteResourceBoundary.propTypes={children:PropTypes.node.isRequired,renderError:PropTypes.func.isRequired,onLoadError:PropTypes.func,fallback:PropTypes.node};var useOptimism=function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return[t,function(){return n.setCache.apply(n,arguments),n.remoteSave.apply(n,arguments)},function(){return n.deleteCache.apply(n,arguments),n.remoteDelete.apply(n,arguments)}]},usePessimism=function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return[t,{refresh:n.refresh,save:function(){return n.remoteSave.apply(n,arguments).then(n.setCache)},delete:function(){return n.remoteDelete.apply(n,arguments).then(n.deleteCache)}}]},useSubscribe=function(e){return React.useEffect(e.actions.subscribe,[e.actions]),e},useSuspense=function(e){var r=_slicedToArray(React.useState(null),2),t=r[0],n=r[1],u=React.useRef(!0);if(React.useEffect(function(){return function(){u.current=!1}},[]),t)throw t;return function(){return n(e().then(function(){u.current&&n(null)}).catch(function(){u.current&&n(null)}))}};exports.createRemoteResource=createRemoteResource,exports.RemoteResourceBoundary=RemoteResourceBoundary,exports.useOptimism=useOptimism,exports.usePessimism=usePessimism,exports.useSubscribe=useSubscribe,exports.useSuspense=useSuspense;
