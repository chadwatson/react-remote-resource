"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),React__default=_interopDefault(React),redux=require("redux"),immutable=require("immutable"),Maybe=_interopDefault(require("data.maybe")),PropTypes=_interopDefault(require("prop-types"));function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,r){var t=[],n=!0,a=!1,u=void 0;try{for(var o,c=e[Symbol.iterator]();!(n=(o=c.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){a=!0,u=e}finally{try{n||null==c.return||c.return()}finally{if(a)throw u}}return t}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var Context=React.createContext({registerError:function(){}}),createTaskManager=function(){var t=new Map;return{has:function(e){return t.has(e)},get:function(e){return t.get(e)},run:function(r,e){return t.get(r)||t.set(r,e().then(function(e){return t.delete(r),e}).catch(function(e){throw t.delete(r),e})).get(r)}}},REGISTER_RESOURCE="REGISTER_RESOURCE",RECEIVE_DATA="RECEIVE_DATA",DELETE_ENTRY="DELETE_ENTRY",store=redux.createStore(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:immutable.Map(),r=1<arguments.length?arguments[1]:void 0;switch(r.type){case REGISTER_RESOURCE:return e.set(r.resourceId,immutable.Map());case RECEIVE_DATA:return e.setIn([r.resourceId,r.entryKey],immutable.Map({updatedAt:r.now,data:r.data}));case DELETE_ENTRY:return e.deleteIn([r.resourceId,r.entryKey]);default:return e}}),defaultCreateCacheKey=function(e){return e.join("-")||"INDEX"},createRemoteResource=function(e){var d=e.id,r=e.load,a=void 0===r?function(){return Promise.resolve()}:r,t=e.save,E=void 0===t?function(){return Promise.resolve()}:t,n=e.delete,R=void 0===n?function(){return Promise.resolve()}:n,u=e.initialValue,o=void 0===u?null:u,c=e.invalidateAfter,y=void 0===c?3e5:c,i=e.createEntryKey,p=void 0===i?defaultCreateCacheKey:i;store.dispatch({type:REGISTER_RESOURCE,resourceId:d});var v=createTaskManager(),h=createTaskManager(),m=createTaskManager(),_=function(e){return Maybe.fromNullable(store.getState().getIn([d,e]))},T=function(e){return e.map(function(e){return e.get("data")}).getOrElse(o)},b=function(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var n=p(r);return v.run(n,function(){return a.apply(void 0,r).then(function(e){return store.dispatch({type:RECEIVE_DATA,now:Date.now(),entryKey:p(r),data:e,resourceId:d}),e})})};return function(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var n,a=p(r),u=React.useContext(Context).registerError,o=_slicedToArray(React.useState(_(a)),2),c=o[0],i=o[1],s=(n=c,n.map(function(e){return e.get("updatedAt")})).map(function(e){return e+y<Date.now()}).getOrElse(!0);React.useEffect(function(){return store.subscribe(function(){var e=_(a);e!==c&&i(e)})},[a]);var l=React.useRef(0);if(l.current=l.current+1,1===l.current&&s&&!v.has(a)&&b.apply(void 0,r).catch(u),s&&v.has(a))throw v.get(a);var f=React.useMemo(function(){return{refresh:function(){return b.apply(void 0,r).catch(u)},setCache:function(e){var r="function"==typeof e?e(T(c)):e;return store.dispatch({type:RECEIVE_DATA,now:Date.now(),data:r,entryKey:a,resourceId:d}),r},deleteCache:function(){return store.dispatch({type:DELETE_ENTRY,entryKey:a,resourceId:d}),T(c)},remoteSave:function(e){h.run(a,function(){return E(e)})},remoteDelete:function(){m.run(a,function(){return R(T(c))})}}},[a]);return[T(c),f]}},RemoteResourceBoundary=function(e){var r=e.children,t=e.onLoadError,n=e.fallback,a=void 0===n?null:n,u=e.renderError,o=void 0===u?function(e){return null}:u,c=_slicedToArray(React.useState(Maybe.Nothing()),2),i=c[0],s=c[1],l=React.useMemo(function(){return{registerError:function(e){s(Maybe.of(e)),t(e)}}},[t]),f=React.useCallback(function(){s(Maybe.Nothing())},[]);return React__default.createElement(Context.Provider,{value:l},i.map(function(e){return o(e,f)}).getOrElse(React__default.createElement(React.Suspense,{fallback:a},r)))};RemoteResourceBoundary.propTypes={children:PropTypes.node.isRequired,renderError:PropTypes.func.isRequired,onLoadError:PropTypes.func,fallback:PropTypes.node};var useSuspense=function(e){var r=_slicedToArray(React.useState(null),2),t=r[0],n=r[1],a=React.useRef(!0);if(React.useEffect(function(){return function(){a.current=!1}},[]),t)throw t;return function(){return n(e().then(function(){a.current&&n(null)}).catch(function(){a.current&&n(null)}))}};exports.createRemoteResource=createRemoteResource,exports.RemoteResourceBoundary=RemoteResourceBoundary,exports.useSuspense=useSuspense;
